# å®Œæ•´çš„æ€æºç¬”è®° TypeScript + Svelte æ’ä»¶å¼€å‘ Google ç¼–ç è§„èŒƒæŒ‡å—

è¿™æ˜¯ä¸€ä»½ä¸ºæ€æºç¬”è®°æ’ä»¶å¼€å‘é‡èº«å®šåˆ¶çš„è¶…è¯¦ç»† Google ç¼–ç è§„èŒƒæŒ‡å—ï¼Œæ¶µç›–äº† TypeScript + Svelte å¼€å‘çš„æ–¹æ–¹é¢é¢ï¼Œä»åŸºç¡€é…ç½®åˆ°é«˜çº§æœ€ä½³å®è·µï¼ŒåŠ©ä½ å¼€å‘å‡ºä¼ä¸šçº§è´¨é‡çš„æ’ä»¶ã€‚

## ğŸ¯ æ ¸å¿ƒåŸåˆ™ä¸ç†å¿µ

### Google TypeScript Style Guide æ ¸å¿ƒå‡†åˆ™

Google TypeScript Style Guide åŸºäºä»¥ä¸‹å››ä¸ªæ ¸å¿ƒåŸåˆ™ï¼š

**1. é¿å…å·²çŸ¥é—®é¢˜æ¨¡å¼**  
ä»£ç å¿…é¡»é¿å…å·²çŸ¥ä¼šå¯¼è‡´é—®é¢˜çš„æ¨¡å¼ï¼Œç‰¹åˆ«æ˜¯å¯¹è¯­è¨€æ–°æ‰‹è€Œè¨€ã€‚è¿™åŒ…æ‹¬é¿å… `@ts-ignore`ã€ä¸ä½¿ç”¨ `var` å£°æ˜ã€ä¸ä½¿ç”¨ `namespace` ç­‰ã€‚

**2. è·¨é¡¹ç›®ä¸€è‡´æ€§**  
å½“å­˜åœ¨ä¸¤ä¸ªè¡¨é¢ä¸Šç­‰æ•ˆçš„é€‰é¡¹æ—¶ï¼Œåº”é€‰æ‹©å…¶ä¸­ä¸€ä¸ªä»¥é¿å…æ— æ•…åˆ†åŒ–æ¼”è¿›ï¼Œé¿å…åœ¨ä»£ç å®¡æŸ¥ä¸­è¿›è¡Œæ— æ„ä¹‰çš„äº‰è®ºã€‚ä¾‹å¦‚ï¼š
- å‘½åçš„å¤§å†™é£æ ¼
- `x as T` è¯­æ³• vs `<T>x` è¯­æ³•ï¼ˆåè€…è¢«ç¦æ­¢ï¼‰
- `Array<[number, number]>` vs `[number, number][]`

**3. é•¿æœŸå¯ç»´æŠ¤æ€§**  
ä»£ç é€šå¸¸æ¯”åŸä½œè€…å·¥ä½œçš„æ—¶é—´æ›´é•¿ï¼ŒTypeScript å›¢é˜Ÿå¿…é¡»ä¿æŒæ‰€æœ‰ Google ä»£ç åœ¨æœªæ¥çš„æ­£å¸¸å·¥ä½œã€‚åŒ…æ‹¬ï¼š
- ä½¿ç”¨è½¯ä»¶è‡ªåŠ¨åŒ–ä»£ç æ›´æ”¹ï¼Œå› æ­¤ä»£ç ä¼šè¢«è‡ªåŠ¨æ ¼å¼åŒ–
- è¦æ±‚å•ä¸€çš„ç¼–è¯‘å™¨æ ‡å¿—é›†
- ä»£ç å¿…é¡»å¯¼å…¥æ‰€ä½¿ç”¨çš„åº“ï¼ˆä¸¥æ ¼ä¾èµ–ï¼‰
- è¦æ±‚ç”¨æˆ·ç¼–å†™æµ‹è¯•

**4. ä¸“æ³¨ä»£ç è´¨é‡è€Œéä»»æ„è§„åˆ™**  
ä»£ç å®¡æŸ¥è€…åº”ä¸“æ³¨äºæ”¹è¿›ä»£ç è´¨é‡ï¼Œè€Œä¸æ˜¯æ‰§è¡Œä»»æ„è§„åˆ™ã€‚å¦‚æœå¯ä»¥å°†è§„åˆ™å®ç°ä¸ºè‡ªåŠ¨æ£€æŸ¥ï¼Œè¿™é€šå¸¸æ˜¯ä¸€ä¸ªå¥½å…†å¤´ã€‚

### æ€æºç¬”è®°æ’ä»¶å¼€å‘ç‰¹æ®Šè€ƒè™‘

æ€æºç¬”è®°æ’ä»¶å¼€å‘æœ‰ä»¥ä¸‹ç‰¹æ®Šè¦æ±‚ï¼š

1. **å¿…é¡»ä½¿ç”¨å†…æ ¸ API** - å¦‚æœæ’ä»¶éœ€è¦ç›´æ¥è¯»å†™æ•°æ®ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼Œå¿…é¡»ä½¿ç”¨å†…æ ¸ API å®ç°ï¼Œä¸å¾—ç›´æ¥è°ƒç”¨ fs æˆ–å…¶ä»– electronã€nodejs API
2. **å¤šè®¾å¤‡åŒæ­¥å…¼å®¹** - è€ƒè™‘å¤šè®¾å¤‡åŒæ—¶è¿è¡Œæ—¶çš„é…ç½®å†²çªé—®é¢˜
3. **å›½é™…åŒ–æ”¯æŒ** - æ’ä»¶è‡³å°‘è¦æ”¯æŒè‹±æ–‡å’Œç®€ä½“ä¸­æ–‡
4. **ä½¿ç”¨ç‹¬ç«‹å·¥ä½œç©ºé—´** - å¼€å‘æ—¶å¼ºçƒˆå»ºè®®ä½¿ç”¨ç‹¬ç«‹çš„å·¥ä½œç©ºé—´ï¼Œé¿å…å¯¹è‡ªå·±çš„ç¬”è®°æ•°æ®äº§ç”Ÿä¸è‰¯å½±å“

## ğŸ› ï¸ å®Œæ•´çš„å·¥å…·é“¾é…ç½®

### é¡¹ç›®åˆå§‹åŒ–

```bash
# 1. å…‹éš†å®˜æ–¹ Svelte æ¨¡æ¿
git clone https://github.com/siyuan-note/plugin-sample-vite-svelte.git my-plugin
cd my-plugin

# 2. å®‰è£… Google TypeScript Style ç›¸å…³ä¾èµ–
npm install --save-dev gts eslint-plugin-svelte prettier-plugin-svelte
npm install --save-dev @typescript-eslint/eslint-plugin @typescript-eslint/parser
npm install --save-dev eslint-config-prettier eslint-plugin-prettier

# 3. åˆå§‹åŒ– GTS
npx gts init

# 4. å®‰è£…æ€æºç¬”è®°ä¸“ç”¨å·¥å…·
npm install --save-dev siyuan-plugin-cli

# 5. å®‰è£…é¡¹ç›®ä¾èµ–
pnpm install
```

### package.json å®Œæ•´é…ç½®

```json
{
  "name": "my-siyuan-plugin",
  "version": "0.1.0",
  "description": "My SiYuan Plugin with Google Standards",
  "author": "Your Name",
  "scripts": {
    "dev": "vite build --watch",
    "build": "vite build && node scripts/make-package.js",
    "lint": "gts lint && eslint . --ext .ts,.svelte",
    "fix": "gts fix && eslint . --ext .ts,.svelte --fix",
    "format": "prettier --write .",
    "check": "svelte-check --tsconfig ./tsconfig.json",
    "make-link": "npx make-link",
    "make-install": "npx make-install",
    "pre-commit": "npm run format && npm run lint && npm run check",
    "clean": "gts clean",
    "compile": "tsc",
    "prepare": "npm run build"
  },
  "dependencies": {
    "siyuan": "^3.1.10"
  },
  "devDependencies": {
    "gts": "^6.0.2",
    "@types/node": "^22.0.0",
    "@typescript-eslint/eslint-plugin": "^8.0.0",
    "@typescript-eslint/parser": "^8.0.0",
    "eslint": "^8.57.0",
    "eslint-plugin-svelte": "^3.10.1",
    "eslint-config-prettier": "^9.1.0",
    "eslint-plugin-prettier": "^5.2.0",
    "prettier": "^3.3.0",
    "prettier-plugin-svelte": "^3.2.6",
    "svelte": "^4.2.18",
    "svelte-check": "^3.8.4",
    "svelte-eslint-parser": "^0.41.0",
    "typescript": "^5.5.0",
    "vite": "^5.3.0",
    "vite-plugin-static-copy": "^1.0.6",
    "@vite/plugin-legacy": "^5.4.1",
    "terser": "^5.31.0",
    "sass": "^1.77.0",
    "minimist": "^1.2.8",
    "ts-node": "^10.9.2"
  }
}
```

### ESLint é…ç½® (eslint.config.js)

```javascript
import js from '@eslint/js';
import svelte from 'eslint-plugin-svelte';
import tseslint from '@typescript-eslint/typescript-eslint';
import prettier from 'eslint-config-prettier';

export default tseslint.config(
  js.configs.recommended,
  ...tseslint.configs.recommended,
  ...svelte.configs.recommended,
  prettier,
  {
    files: ['**/*.svelte'],
    languageOptions: {
      parserOptions: {
        parser: tseslint.parser,
        extraFileExtensions: ['.svelte']
      }
    }
  },
  {
    ignores: [
      'node_modules/',
      'dist/',
      'build/',
      'temp/',
      '*.config.js',
      'scripts/',
      'public/'
    ]
  },
  {
    rules: {
      // Google TypeScript Style è§„åˆ™
      '@typescript-eslint/no-unused-vars': ['error', { 
        argsIgnorePattern: '^_',
        varsIgnorePattern: '^_',
        caughtErrorsIgnorePattern: '^_'
      }],
      '@typescript-eslint/explicit-function-return-type': 'warn',
      '@typescript-eslint/no-explicit-any': 'error',
      '@typescript-eslint/prefer-const': 'error',
      '@typescript-eslint/no-var-requires': 'error',
      
      // ç¦ç”¨ Google Style ç¦æ­¢çš„ç‰¹æ€§
      '@typescript-eslint/no-namespace': 'error',
      '@typescript-eslint/ban-ts-comment': 'error',
      
      // Svelte ç‰¹å®šè§„åˆ™
      'svelte/indent': ['error', { indent: 2 }],
      'svelte/max-attributes-per-line': ['error', { max: 1 }],
      'svelte/html-self-closing': 'error',
      'svelte/shorthand-attribute': 'error',
      'svelte/shorthand-directive': 'error',
      'svelte/prefer-destructuring-props': 'error',
      
      // é€šç”¨è§„åˆ™
      'prefer-const': 'error',
      'no-var': 'error',
      'eqeqeq': ['error', 'always', { null: 'ignore' }],
      'no-eval': 'error',
      'no-implied-eval': 'error',
      'prefer-arrow-callback': 'error',
      'arrow-body-style': ['error', 'as-needed'],
      
      // å‘½åçº¦å®š
      'camelcase': ['error', { properties: 'never' }],
      
      // æ€æºç¬”è®°ç‰¹å®šè§„åˆ™
      'no-console': ['warn', { allow: ['warn', 'error'] }]
    }
  },
  {
    files: ['**/*.ts', '**/*.tsx'],
    rules: {
      // TypeScript æ–‡ä»¶ç‰¹å®šè§„åˆ™
      '@typescript-eslint/explicit-member-accessibility': 'error',
      '@typescript-eslint/member-ordering': 'error',
      '@typescript-eslint/prefer-readonly': 'error'
    }
  },
  {
    files: ['**/*.svelte'],
    rules: {
      // Svelte æ–‡ä»¶ä¸­å¯ä»¥æ”¾å®½ä¸€äº› TypeScript è§„åˆ™
      '@typescript-eslint/explicit-function-return-type': 'off'
    }
  }
);
```

### TypeScript é…ç½® (tsconfig.json)

```json
{
  "extends": "./node_modules/gts/tsconfig-google.json",
  "compilerOptions": {
    "rootDir": ".",
    "outDir": "build",
    "target": "ES2020",
    "module": "ESNext",
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true,
    "esModuleInterop": true,
    "allowSyntheticDefaultImports": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noImplicitReturns": true,
    "noFallthroughCasesInSwitch": true,
    "noImplicitOverride": true,
    "exactOptionalPropertyTypes": true,
    "noImplicitAny": true,
    "strictNullChecks": true,
    "strictFunctionTypes": true,
    "strictBindCallApply": true,
    "strictPropertyInitialization": true,
    "noImplicitThis": true,
    "useUnknownInCatchVariables": true,
    "alwaysStrict": true,
    "declaration": true,
    "declarationMap": true,
    "sourceMap": true,
    "removeComments": false,
    "experimentalDecorators": false,
    "emitDecoratorMetadata": false,
    "baseUrl": ".",
    "paths": {
      "@/*": ["src/*"],
      "@components/*": ["src/components/*"],
      "@utils/*": ["src/utils/*"],
      "@types/*": ["src/types/*"]
    }
  },
  "include": [
    "src/**/*.ts",
    "src/**/*.svelte",
    "src/**/*.d.ts",
    "vite.config.ts"
  ],
  "exclude": [
    "node_modules",
    "build",
    "dist",
    "temp"
  ],
  "references": [
    {
      "path": "./tsconfig.node.json"
    }
  ]
}
```

### Prettier é…ç½® (.prettierrc.js)

```javascript
module.exports = {
  // Google Style åå¥½è®¾ç½®
  singleQuote: true,
  semi: true,
  trailingComma: 'es5',
  tabWidth: 2,
  useTabs: false,
  printWidth: 80,
  bracketSpacing: false,
  arrowParens: 'avoid',
  endOfLine: 'lf',
  
  // Svelte ç‰¹å®šè®¾ç½®
  plugins: ['prettier-plugin-svelte'],
  svelteSortOrder: 'options-styles-scripts-markup',
  svelteStrictMode: false,
  svelteBracketNewLine: true,
  svelteIndentScriptAndStyle: true,
  svelteAllowShorthand: true,
  
  // æ–‡ä»¶ç‰¹å®šè¦†ç›–
  overrides: [
    {
      files: '*.svelte',
      options: {
        parser: 'svelte',
        printWidth: 100 // Svelte æ–‡ä»¶å¯ä»¥ç¨å¾®å®½ä¸€äº›
      }
    },
    {
      files: ['*.json', '*.yaml', '*.yml'],
      options: {
        tabWidth: 2
      }
    }
  ]
};
```

### Vite é…ç½®ä¼˜åŒ– (vite.config.ts)

```typescript
import {defineConfig} from 'vite';
import {svelte} from '@sveltejs/vite-plugin-svelte';
import {viteStaticCopy} from 'vite-plugin-static-copy';
import legacy from '@vitejs/plugin-legacy';
import {resolve} from 'path';
import minimist from 'minimist';

const args = minimist(process.argv.slice(2));
const isWatch = args.watch || args.w || false;

export default defineConfig({
  plugins: [
    svelte({
      compilerOptions: {
        dev: isWatch,
        css: 'injected'
      },
      emitCss: false
    }),
    viteStaticCopy({
      targets: [
        {src: 'README*.md', dest: './'},
        {src: 'plugin.json', dest: './'},
        {src: 'preview.png', dest: './'},
        {src: 'icon.png', dest: './'},
        {src: 'public/i18n/**', dest: './i18n/'}
      ]
    }),
    legacy({
      targets: ['chrome >= 88'],
      modernPolyfills: false
    })
  ],
  define: {
    'process.env.NODE_ENV': JSON.stringify(
      isWatch ? 'development' : 'production'
    ),
    'process.env.DEV_MODE': JSON.stringify(isWatch)
  },
  build: {
    outDir: isWatch ? 'dev' : 'dist',
    emptyOutDir: false,
    minify: !isWatch,
    sourcemap: isWatch ? 'inline' : false,
    lib: {
      entry: resolve(__dirname, 'src/index.ts'),
      fileName: 'index',
      formats: ['cjs']
    },
    rollupOptions: {
      external: ['siyuan'],
      output: {
        entryFileNames: '[name].js',
        assetFileNames: assetInfo => {
          if (assetInfo.name?.endsWith('.css')) {
            return 'index.css';
          }
          return '[name].[ext]';
        }
      }
    },
    target: 'esnext',
    cssCodeSplit: false
  },
  resolve: {
    alias: {
      '@': resolve(__dirname, 'src'),
      '@components': resolve(__dirname, 'src/components'),
      '@utils': resolve(__dirname, 'src/utils'),
      '@types': resolve(__dirname, 'src/types')
    }
  },
  server: {
    host: 'localhost',
    port: 3000,
    strictPort: true
  }
});
```

## ğŸ“‚ æ¨èçš„é¡¹ç›®ç»“æ„

```
my-plugin/
â”œâ”€â”€ src/                          # æºä»£ç ç›®å½•
â”‚   â”œâ”€â”€ index.ts                  # æ’ä»¶å…¥å£ç‚¹ (UpperCamelCase class)
â”‚   â”œâ”€â”€ components/               # Svelte ç»„ä»¶ (PascalCase)
â”‚   â”‚   â”œâ”€â”€ SettingsPanel.svelte
â”‚   â”‚   â”œâ”€â”€ PluginDialog.svelte
â”‚   â”‚   â””â”€â”€ index.ts              # ç»„ä»¶å¯¼å‡º
â”‚   â”œâ”€â”€ utils/                    # å·¥å…·å‡½æ•° (camelCase)
â”‚   â”‚   â”œâ”€â”€ apiClient.ts
â”‚   â”‚   â”œâ”€â”€ constants.ts
â”‚   â”‚   â”œâ”€â”€ helpers.ts
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”œâ”€â”€ types/                    # ç±»å‹å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ plugin-types.ts
â”‚   â”‚   â”œâ”€â”€ api-types.ts
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”œâ”€â”€ stores/                   # Svelte stores
â”‚   â”‚   â”œâ”€â”€ pluginStore.ts
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â””â”€â”€ styles/                   # æ ·å¼æ–‡ä»¶
â”‚       â”œâ”€â”€ global.scss
â”‚       â””â”€â”€ components.scss
â”œâ”€â”€ public/                       # é™æ€èµ„æº
â”‚   â”œâ”€â”€ i18n/                     # å›½é™…åŒ–æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ en_US.yaml
â”‚   â”‚   â”œâ”€â”€ zh_CN.yaml
â”‚   â”‚   â””â”€â”€ zh_CHT.yaml
â”‚   â”œâ”€â”€ icon.png                  # æ’ä»¶å›¾æ ‡
â”‚   â””â”€â”€ preview.png               # é¢„è§ˆå›¾
â”œâ”€â”€ scripts/                      # æ„å»ºè„šæœ¬
â”‚   â”œâ”€â”€ make-package.js
â”‚   â””â”€â”€ make-dev-link.js
â”œâ”€â”€ dist/                         # æ„å»ºè¾“å‡º (ç”Ÿäº§)
â”œâ”€â”€ dev/                          # å¼€å‘è¾“å‡º
â”œâ”€â”€ plugin.json                   # æ’ä»¶é…ç½®
â”œâ”€â”€ vite.config.ts               # Vite é…ç½®
â”œâ”€â”€ tsconfig.json                # TypeScript é…ç½®
â”œâ”€â”€ eslint.config.js             # ESLint é…ç½®
â”œâ”€â”€ .prettierrc.js               # Prettier é…ç½®
â”œâ”€â”€ .gitignore
â””â”€â”€ README.md
```

## ğŸ¯ Google TypeScript å‘½åè§„èŒƒè¯¦è§£

### æ ‡è¯†ç¬¦å‘½åè§„åˆ™

TypeScript ä¸­çš„æ ‡è¯†ç¬¦å¿…é¡»åªä½¿ç”¨ ASCII å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ï¼ˆç”¨äºå¸¸é‡å’Œç»“æ„åŒ–æµ‹è¯•æ–¹æ³•åï¼‰å’Œ '$' ç¬¦å·ã€‚æ¯ä¸ªæœ‰æ•ˆçš„æ ‡è¯†ç¬¦åç§°éƒ½ç”±æ­£åˆ™è¡¨è¾¾å¼ `[$\w]+` åŒ¹é…ã€‚

| é£æ ¼ | ä½¿ç”¨åœºæ™¯ | ç¤ºä¾‹ |
|------|---------|------|
| `UpperCamelCase` | ç±»ã€æ¥å£ã€ç±»å‹ã€æšä¸¾ã€è£…é¥°å™¨ã€ç±»å‹å‚æ•° | `UserProfile`, `ApiResponse`, `PluginSettings` |
| `lowerCamelCase` | å˜é‡ã€å‚æ•°ã€å‡½æ•°ã€æ–¹æ³•ã€å±æ€§ã€æ¨¡å—åˆ«å | `userName`, `getUserData()`, `isEnabled` |
| `CONSTANT_CASE` | å…¨å±€å¸¸é‡å€¼ï¼ŒåŒ…æ‹¬æšä¸¾å€¼ | `MAX_RETRY_COUNT`, `API_BASE_URL` |

### æ€æºç¬”è®°ç‰¹å®šå‘½åçº¦å®š

```typescript
// æ’ä»¶ä¸»ç±»å‘½å (UpperCamelCase)
export default class MyAwesomePlugin extends Plugin {
  // ç§æœ‰å­—æ®µ (lowerCamelCase with private)
  private readonly settingsPanel: SettingsPanel;
  private readonly apiClient: ApiClient;
  
  // å¸¸é‡ (CONSTANT_CASE)
  private static readonly MAX_CACHE_SIZE = 100;
  private static readonly DEFAULT_TIMEOUT = 5000;
  
  // å…¬å…±æ–¹æ³• (lowerCamelCase)
  async onload(): Promise<void> {
    await this.initializePlugin();
  }
  
  // ç§æœ‰æ–¹æ³• (lowerCamelCase)
  private async initializePlugin(): Promise<void> {
    // å®ç°ä»£ç 
  }
  
  // äº‹ä»¶å¤„ç†å™¨ (lowerCamelCase)
  private handleSettingsChange = (settings: PluginSettings): void => {
    this.updateConfiguration(settings);
  };
}
```

### æ–‡ä»¶å’Œç›®å½•å‘½å

```typescript
// æ–‡ä»¶å‘½åä½¿ç”¨ camelCase
src/
â”œâ”€â”€ pluginManager.ts         // âœ“ æ­£ç¡®
â”œâ”€â”€ apiClientUtils.ts        // âœ“ æ­£ç¡®  
â”œâ”€â”€ plugin_manager.ts        // âœ— é¿å…ä¸‹åˆ’çº¿
â”œâ”€â”€ PluginManager.ts         // âœ— é¿å… PascalCase

// ç»„ä»¶æ–‡ä»¶ä½¿ç”¨ PascalCase (Svelte çº¦å®š)
components/
â”œâ”€â”€ SettingsPanel.svelte     // âœ“ æ­£ç¡®
â”œâ”€â”€ UserProfile.svelte       // âœ“ æ­£ç¡®
â”œâ”€â”€ settingsPanel.svelte     // âœ— é¿å… camelCase
```

## ğŸ”§ æ ¸å¿ƒ TypeScript ç¼–ç è§„èŒƒ

### å˜é‡å£°æ˜å’Œç±»å‹æ³¨è§£

```typescript
// âœ“ æ­£ç¡®ï¼šä½¿ç”¨ const å’Œ letï¼Œé¿å… var
const API_ENDPOINT = 'https://api.example.com';
let currentUser: User | null = null;

// âœ“ æ­£ç¡®ï¼šç±»å‹æ¨æ–­è¶³å¤Ÿæ—¶çœç•¥ç±»å‹æ³¨è§£
const isEnabled = true;  // ç±»å‹æ¨æ–­ä¸º boolean
const users = new Set<string>();  // æ˜ç¡®æ³›å‹ç±»å‹

// âœ— é”™è¯¯ï¼šä¸å¿…è¦çš„ç±»å‹æ³¨è§£
const isEnabled: boolean = true;
const users: Set<string> = new Set<string>();

// âœ“ æ­£ç¡®ï¼šå¤æ‚ç±»å‹éœ€è¦æ³¨è§£
const config: PluginConfig = await loadConfig();
const response: ApiResponse<UserData> = await fetchUserData();
```

### å‡½æ•°å£°æ˜å’Œç®­å¤´å‡½æ•°

å¯¹äºå‘½åå‡½æ•°ï¼Œä¼˜å…ˆä½¿ç”¨å‡½æ•°å£°æ˜è€Œä¸æ˜¯ç®­å¤´å‡½æ•°æˆ–å‡½æ•°è¡¨è¾¾å¼ã€‚ç®­å¤´å‡½æ•°å¯ä»¥åœ¨éœ€è¦æ˜¾å¼ç±»å‹æ³¨è§£æ—¶ä½¿ç”¨ã€‚

```typescript
// âœ“ æ­£ç¡®ï¼šå‡½æ•°å£°æ˜ç”¨äºå‘½åå‡½æ•°
function processUserData(userData: UserData): ProcessedData {
  return {
    id: userData.id,
    name: userData.name.trim(),
    email: userData.email.toLowerCase()
  };
}

// âœ“ æ­£ç¡®ï¼šç®­å¤´å‡½æ•°ç”¨äºéœ€è¦ç±»å‹æ³¨è§£çš„åœºæ™¯
interface SearchFunction {
  (source: string, pattern: string): boolean;
}

const searchInText: SearchFunction = (source, pattern) => {
  return source.includes(pattern);
};

// âœ“ æ­£ç¡®ï¼šæ–¹æ³•ä½“ä¸­ä½¿ç”¨ç®­å¤´å‡½æ•°ï¼ˆè®¿é—®å¤–éƒ¨ thisï¼‰
class PluginManager {
  private plugins: Plugin[] = [];
  
  loadPlugins(): void {
    // ç®­å¤´å‡½æ•°ä¿æŒ this ç»‘å®š
    this.plugins.forEach(plugin => {
      plugin.initialize();
    });
  }
  
  // âœ“ æ­£ç¡®ï¼šäº‹ä»¶å¤„ç†å™¨ä½¿ç”¨ç®­å¤´å‡½æ•°å±æ€§
  private handlePluginError = (error: Error): void => {
    console.error('Plugin error:', error.message);
  };
}
```

### ç±»å’Œæ¥å£å®šä¹‰

```typescript
// âœ“ æ­£ç¡®ï¼šç±»å®šä¹‰
class SiYuanPlugin extends Plugin {
  // å­—æ®µåˆå§‹åŒ–ï¼ˆä¼˜å…ˆåœ¨å£°æ˜å¤„åˆå§‹åŒ–ï¼‰
  private readonly eventHandlers: Map<string, Function> = new Map();
  private isInitialized = false;
  
  // å‚æ•°å±æ€§ï¼ˆå‡å°‘æ ·æ¿ä»£ç ï¼‰
  constructor(
    private readonly config: PluginConfig,
    private readonly logger: Logger
  ) {
    super();
  }
  
  // æ–¹æ³•å£°æ˜é—´ç”¨ç©ºè¡Œåˆ†éš”
  async onload(): Promise<void> {
    await this.initializeComponents();
    this.isInitialized = true;
  }
  
  private async initializeComponents(): Promise<void> {
    // å®ç°ä»£ç 
  }
}

// âœ“ æ­£ç¡®ï¼šæ¥å£å®šä¹‰ï¼ˆä¼˜å…ˆäºç±»å‹åˆ«åï¼‰
interface PluginSettings {
  readonly apiKey: string;
  readonly enableDebug: boolean;
  readonly maxRetries: number;
  readonly themes?: string[];  // å¯é€‰å±æ€§ä½¿ç”¨ ?
}

// âœ“ æ­£ç¡®ï¼šä½¿ç”¨ç»“æ„åŒ–ç±»å‹
const settings: PluginSettings = {
  apiKey: 'sk-xxx',
  enableDebug: false,
  maxRetries: 3
};

// âœ— é”™è¯¯ï¼šé¿å… default exports
export default class MyPlugin { }  // ä¸æ¨è

// âœ“ æ­£ç¡®ï¼šä½¿ç”¨ named exports
export class MyPlugin { }
```

### å¯¼å…¥å’Œå¯¼å‡ºè§„èŒƒ

ä½¿ç”¨å‘½åå¯¼å‡ºè€Œä¸æ˜¯é»˜è®¤å¯¼å‡ºã€‚è¿™ç¡®ä¿æ‰€æœ‰å¯¼å…¥éµå¾ªç»Ÿä¸€æ¨¡å¼ã€‚

```typescript
// âœ“ æ­£ç¡®ï¼šå‘½åå¯¼å…¥/å¯¼å‡º
// utils/apiClient.ts
export const API_BASE_URL = 'https://api.siyuan.com';

export interface ApiResponse<T> {
  data: T;
  status: number;
  message: string;
}

export class ApiClient {
  async get<T>(endpoint: string): Promise<ApiResponse<T>> {
    // å®ç°
  }
}

// ä½¿ç”¨æ—¶
import {ApiClient, ApiResponse, API_BASE_URL} from '@/utils/apiClient';

// âœ“ æ­£ç¡®ï¼šå‘½åç©ºé—´å¯¼å…¥ï¼ˆå¤§é‡ç¬¦å·æ—¶ï¼‰
import * as apiUtils from '@/utils/apiClient';
const client = new apiUtils.ApiClient();

// âœ“ æ­£ç¡®ï¼šç±»å‹å¯¼å…¥
import type {PluginSettings} from '@/types/plugin-types';
import type {User} from '@/types/user-types';

// âœ— é”™è¯¯ï¼šé¿å…é»˜è®¤å¯¼å‡º
export default class ApiClient { }  // ä¸æ¨è
import ApiClient from '@/utils/apiClient';  // ä¸æ¨è
```

### é”™è¯¯å¤„ç†å’Œç±»å‹å®‰å…¨

```typescript
// âœ“ æ­£ç¡®ï¼šæŠ›å‡º Error å®ä¾‹
function validateUserInput(input: unknown): UserInput {
  if (!isValidUserInput(input)) {
    throw new Error('Invalid user input format');
  }
  return input;
}

// âœ“ æ­£ç¡®ï¼šç±»å‹å®ˆå«è€Œä¸æ˜¯ç±»å‹æ–­è¨€
function isValidUserInput(input: unknown): input is UserInput {
  return typeof input === 'object' && 
         input !== null && 
         'name' in input && 
         'email' in input;
}

// âœ“ æ­£ç¡®ï¼šcatch å—ä¸­çš„é”™è¯¯å¤„ç†
async function loadPluginData(): Promise<PluginData> {
  try {
    const response = await fetch('/api/plugin-data');
    return await response.json();
  } catch (error: unknown) {
    // æ–­è¨€é”™è¯¯ç±»å‹
    if (error instanceof Error) {
      console.error('Failed to load plugin data:', error.message);
      throw error;
    }
    throw new Error('Unknown error occurred');
  }
}

// âœ“ æ­£ç¡®ï¼šä½¿ç”¨ unknown è€Œä¸æ˜¯ any
function processApiResponse(data: unknown): ProcessedData {
  // ç±»å‹æ”¶çª„
  if (isApiResponseData(data)) {
    return processValidData(data);
  }
  throw new Error('Invalid API response format');
}
```

## ğŸ¨ Svelte ç»„ä»¶ç¼–ç è§„èŒƒ

### ç»„ä»¶ç»“æ„å’Œé£æ ¼

```svelte
<!-- âœ“ æ­£ç¡®ï¼šSvelte ç»„ä»¶ç»“æ„ -->
<script lang="ts">
  // 1. å¯¼å…¥è¯­å¥
  import type {Plugin} from 'siyuan';
  import type {PluginSettings} from '@/types/plugin-types';
  import {createEventDispatcher} from 'svelte';
  import Button from '@/components/Button.svelte';
  
  // 2. å¯¼å‡ºçš„ propsï¼ˆæ˜ç¡®ç±»å‹ï¼‰
  export let plugin: Plugin;
  export let settings: PluginSettings;
  export let isVisible = false;
  
  // 3. äº‹ä»¶åˆ†å‘å™¨
  const dispatch = createEventDispatcher<{
    save: PluginSettings;
    cancel: void;
    error: {message: string};
  }>();
  
  // 4. æœ¬åœ°çŠ¶æ€
  let isLoading = false;
  let errorMessage: string | null = null;
  let formData = {...settings};
  
  // 5. å“åº”å¼å£°æ˜
  $: isFormValid = formData.apiKey.length > 0 && formData.maxRetries > 0;
  $: canSave = isFormValid && !isLoading;
  
  // 6. å‡½æ•°å®šä¹‰ï¼ˆæ˜ç¡®è¿”å›ç±»å‹ï¼‰
  async function handleSave(): Promise<void> {
    isLoading = true;
    errorMessage = null;
    
    try {
      await validateSettings(formData);
      dispatch('save', formData);
      plugin.showMessage('Settings saved successfully');
    } catch (error: unknown) {
      if (error instanceof Error) {
        errorMessage = error.message;
        dispatch('error', {message: error.message});
      } else {
        errorMessage = 'An unknown error occurred';
      }
    } finally {
      isLoading = false;
    }
  }
  
  function handleCancel(): void {
    formData = {...settings};  // é‡ç½®è¡¨å•
    dispatch('cancel');
  }
  
  function validateSettings(data: PluginSettings): void {
    if (!data.apiKey.trim()) {
      throw new Error('API Key is required');
    }
    if (data.maxRetries < 1 || data.maxRetries > 10) {
      throw new Error('Max retries must be between 1 and 10');
    }
  }
</script>

<!-- âœ“ æ­£ç¡®ï¼šHTML æ¨¡æ¿ -->
<div class="settings-panel" class:visible={isVisible}>
  <header class="panel-header">
    <h2>{plugin.i18n.settingsTitle}</h2>
  </header>
  
  <main class="panel-content">
    {#if errorMessage}
      <div class="error-message" role="alert">
        {errorMessage}
      </div>
    {/if}
    
    <form on:submit|preventDefault={handleSave}>
      <div class="form-group">
        <label for="api-key">{plugin.i18n.apiKeyLabel}</label>
        <input
          id="api-key"
          type="password"
          bind:value={formData.apiKey}
          placeholder={plugin.i18n.apiKeyPlaceholder}
          required
        />
      </div>
      
      <div class="form-group">
        <label for="max-retries">{plugin.i18n.maxRetriesLabel}</label>
        <input
          id="max-retries"
          type="number"
          bind:value={formData.maxRetries}
          min="1"
          max="10"
          required
        />
      </div>
      
      <div class="form-group checkbox-group">
        <label>
          <input
            type="checkbox"
            bind:checked={formData.enableDebug}
          />
          {plugin.i18n.enableDebugLabel}
        </label>
      </div>
    </form>
  </main>
  
  <footer class="panel-actions">
    <Button
      variant="secondary"
      on:click={handleCancel}
      disabled={isLoading}
    >
      {plugin.i18n.cancel}
    </Button>
    
    <Button
      variant="primary"
      on:click={handleSave}
      disabled={!canSave}
      loading={isLoading}
    >
      {isLoading ? plugin.i18n.saving : plugin.i18n.save}
    </Button>
  </footer>
</div>

<!-- âœ“ æ­£ç¡®ï¼šæ ·å¼å®šä¹‰ -->
<style lang="scss">
  .settings-panel {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 480px;
    max-height: 80vh;
    background: var(--b3-theme-background);
    border: 1px solid var(--b3-theme-border);
    border-radius: 8px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    display: none;
    
    &.visible {
      display: flex;
      flex-direction: column;
    }
  }
  
  .panel-header {
    padding: 16px 20px;
    border-bottom: 1px solid var(--b3-theme-border);
    
    h2 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
      color: var(--b3-theme-on-background);
    }
  }
  
  .panel-content {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
  }
  
  .error-message {
    padding: 8px 12px;
    margin-bottom: 16px;
    background: var(--b3-theme-error-lighter);
    color: var(--b3-theme-error);
    border: 1px solid var(--b3-theme-error-light);
    border-radius: 4px;
    font-size: 14px;
  }
  
  .form-group {
    margin-bottom: 16px;
    
    label {
      display: block;
      margin-bottom: 4px;
      font-size: 14px;
      font-weight: 500;
      color: var(--b3-theme-on-background);
    }
    
    input[type="text"],
    input[type="password"],
    input[type="number"] {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--b3-theme-border);
      border-radius: 4px;
      font-size: 14px;
      background: var(--b3-theme-surface);
      color: var(--b3-theme-on-surface);
      
      &:focus {
        outline: none;
        border-color: var(--b3-theme-primary);
        box-shadow: 0 0 0 2px var(--b3-theme-primary-light);
      }
    }
    
    &.checkbox-group {
      label {
        display: flex;
        align-items: center;
        cursor: pointer;
        
        input[type="checkbox"] {
          margin-right: 8px;
        }
      }
    }
  }
  
  .panel-actions {
    padding: 16px 20px;
    border-top: 1px solid var(--b3-theme-border);
    display: flex;
    justify-content: flex-end;
    gap: 8px;
  }
</style>
```

### Svelte Store æ¨¡å¼

```typescript
// stores/pluginStore.ts
import {writable, derived, readable} from 'svelte/store';
import type {Plugin} from 'siyuan';
import type {PluginSettings, PluginState} from '@/types/plugin-types';

// âœ“ æ­£ç¡®ï¼šç±»å‹åŒ–çš„ stores
export const pluginInstance = writable<Plugin | null>(null);

export const pluginSettings = writable<PluginSettings>({
  apiKey: '',
  enableDebug: false,
  maxRetries: 3,
  theme: 'auto'
});

export const pluginState = writable<PluginState>({
  isLoading: false,
  isInitialized: false,
  lastError: null,
  connectionStatus: 'disconnected'
});

// âœ“ æ­£ç¡®ï¼šæ´¾ç”Ÿ stores
export const isPluginReady = derived(
  [pluginInstance, pluginState],
  ([$plugin, $state]) => $plugin !== null && $state.isInitialized
);

export const hasValidSettings = derived(
  pluginSettings,
  $settings => $settings.apiKey.length > 0 && $settings.maxRetries > 0
);

// âœ“ æ­£ç¡®ï¼šå¼‚æ­¥ stores
export function createAsyncStore<T>(
  initialValue: T,
  fetcher: () => Promise<T>
) {
  const store = writable<{
    data: T;
    loading: boolean;
    error: Error | null;
  }>({
    data: initialValue,
    loading: false,
    error: null
  });

  const load = async (): Promise<void> => {
    store.update(state => ({...state, loading: true, error: null}));
    
    try {
      const data = await fetcher();
      store.update(state => ({...state, data, loading: false}));
    } catch (error: unknown) {
      const errorInstance = error instanceof Error 
        ? error 
        : new Error('Unknown error');
      store.update(state => ({...state, loading: false, error: errorInstance}));
    }
  };

  return {
    subscribe: store.subscribe,
    load
  };
}

// ä½¿ç”¨ç¤ºä¾‹
export const userDataStore = createAsyncStore(
  null as UserData | null,
  () => fetchUserData()
);
```

## ğŸŒ å›½é™…åŒ–æœ€ä½³å®è·µ

### å¤šè¯­è¨€æ–‡ä»¶ç»“æ„

```yaml
# public/i18n/en_US.yaml
plugin:
  name: "My Awesome Plugin"
  description: "A powerful plugin for SiYuan"

ui:
  buttons:
    save: "Save"
    cancel: "Cancel"
    reset: "Reset"
    delete: "Delete"
  
  labels:
    apiKey: "API Key"
    maxRetries: "Max Retries"
    enableDebug: "Enable Debug Mode"
    theme: "Theme"
  
  messages:
    saveSuccess: "Settings saved successfully"
    saveError: "Failed to save settings: {0}"
    loadError: "Failed to load data: {0}"
    networkError: "Network connection failed"
  
  placeholders:
    apiKeyPlaceholder: "Enter your API key"
    searchPlaceholder: "Search..."

settings:
  title: "Plugin Settings"
  sections:
    general: "General"
    advanced: "Advanced"
    about: "About"

errors:
  invalidApiKey: "Invalid API key format"
  rateLimitExceeded: "Rate limit exceeded. Please try again later."
  networkTimeout: "Request timed out"
```

```yaml
# public/i18n/zh_CN.yaml
plugin:
  name: "æˆ‘çš„å¼ºå¤§æ’ä»¶"
  description: "ä¸€ä¸ªä¸ºæ€æºç¬”è®°è®¾è®¡çš„å¼ºå¤§æ’ä»¶"

ui:
  buttons:
    save: "ä¿å­˜"
    cancel: "å–æ¶ˆ"  
    reset: "é‡ç½®"
    delete: "åˆ é™¤"
  
  labels:
    apiKey: "API å¯†é’¥"
    maxRetries: "æœ€å¤§é‡è¯•æ¬¡æ•°"
    enableDebug: "å¯ç”¨è°ƒè¯•æ¨¡å¼"
    theme: "ä¸»é¢˜"
  
  messages:
    saveSuccess: "è®¾ç½®ä¿å­˜æˆåŠŸ"
    saveError: "ä¿å­˜è®¾ç½®å¤±è´¥ï¼š{0}"
    loadError: "åŠ è½½æ•°æ®å¤±è´¥ï¼š{0}"
    networkError: "ç½‘ç»œè¿æ¥å¤±è´¥"
  
  placeholders:
    apiKeyPlaceholder: "è¯·è¾“å…¥æ‚¨çš„ API å¯†é’¥"
    searchPlaceholder: "æœç´¢..."

settings:
  title: "æ’ä»¶è®¾ç½®"
  sections:
    general: "å¸¸è§„"
    advanced: "é«˜çº§"
    about: "å…³äº"

errors:
  invalidApiKey: "API å¯†é’¥æ ¼å¼æ— æ•ˆ"
  rateLimitExceeded: "è¯·æ±‚é¢‘ç‡è¶…é™ï¼Œè¯·ç¨åé‡è¯•"
  networkTimeout: "è¯·æ±‚è¶…æ—¶"
```

### å›½é™…åŒ–å·¥å…·å‡½æ•°

```typescript
// utils/i18n.ts
import type {Plugin} from 'siyuan';

export class I18nManager {
  constructor(private readonly plugin: Plugin) {}

  /**
   * è·å–ç¿»è¯‘æ–‡æœ¬ï¼Œæ”¯æŒå‚æ•°æ›¿æ¢
   * @param key ç¿»è¯‘é”®ï¼Œæ”¯æŒç‚¹åˆ†éš”çš„åµŒå¥—é”®
   * @param params å‚æ•°æ•°ç»„ï¼Œç”¨äºæ›¿æ¢ {0}, {1} ç­‰å ä½ç¬¦
   */
  t(key: string, ...params: (string | number)[]): string {
    const translation = this.getNestedValue(this.plugin.i18n, key);
    
    if (typeof translation !== 'string') {
      console.warn(`Translation not found for key: ${key}`);
      return key;
    }
    
    return this.replacePlaceholders(translation, params);
  }

  /**
   * è·å–åµŒå¥—å¯¹è±¡å€¼
   */
  private getNestedValue(obj: any, path: string): any {
    return path.split('.').reduce((current, key) => {
      return current && current[key] !== undefined ? current[key] : undefined;
    }, obj);
  }

  /**
   * æ›¿æ¢å ä½ç¬¦
   */
  private replacePlaceholders(
    text: string, 
    params: (string | number)[]
  ): string {
    return text.replace(/{(\d+)}/g, (match, index) => {
      const paramIndex = parseInt(index, 10);
      return paramIndex < params.length 
        ? String(params[paramIndex])
        : match;
    });
  }

  /**
   * è·å–å½“å‰è¯­è¨€ä»£ç 
   */
  getCurrentLanguage(): string {
    return this.plugin.data[':storage'] || 'en_US';
  }

  /**
   * æ£€æŸ¥æ˜¯å¦ä¸ºä¸­æ–‡ç¯å¢ƒ
   */
  isChinese(): boolean {
    return this.getCurrentLanguage().startsWith('zh');
  }
}

// ä½¿ç”¨ç¤ºä¾‹
export function createI18nHelper(plugin: Plugin) {
  const i18n = new I18nManager(plugin);
  
  return {
    t: i18n.t.bind(i18n),
    getCurrentLanguage: i18n.getCurrentLanguage.bind(i18n),
    isChinese: i18n.isChinese.bind(i18n)
  };
}
```

### ç»„ä»¶ä¸­çš„å›½é™…åŒ–ä½¿ç”¨

```svelte
<script lang="ts">
  import type {Plugin} from 'siyuan';
  import {createI18nHelper} from '@/utils/i18n';
  
  export let plugin: Plugin;
  
  const {t} = createI18nHelper(plugin);
  
  let errorCount = 0;
  let username = 'John';
  
  function handleError() {
    errorCount++;
    // ä½¿ç”¨å‚æ•°æ›¿æ¢
    const message = t('ui.messages.saveError', 'Network timeout');
    plugin.showMessage(message, 3000, 'error');
  }
</script>

<div class="user-panel">
  <h2>{t('settings.title')}</h2>
  
  <div class="user-info">
    <span>{t('ui.labels.username')}: {username}</span>
    {#if errorCount > 0}
      <span class="error-count">
        {t('ui.messages.errorCount', errorCount)}
      </span>
    {/if}
  </div>
  
  <button on:click={handleError}>
    {t('ui.buttons.test')}
  </button>
</div>
```

## ğŸ”Œ æ€æºç¬”è®° API é›†æˆè§„èŒƒ

### å†…æ ¸ API ä½¿ç”¨

```typescript
// utils/siYuanApi.ts
import type {Plugin} from 'siyuan';

export class SiYuanApiClient {
  constructor(private readonly plugin: Plugin) {}

  /**
   * æŸ¥è¯¢å—æ•°æ®
   */
  async queryBlocks(sql: string): Promise<Block[]> {
    try {
      const response = await this.plugin.kernelApi('/api/query/sql', {
        stmt: sql
      });
      
      if (response.code !== 0) {
        throw new Error(`API Error: ${response.msg}`);
      }
      
      return response.data || [];
    } catch (error: unknown) {
      if (error instanceof Error) {
        console.error('Failed to query blocks:', error.message);
        throw error;
      }
      throw new Error('Unknown error in queryBlocks');
    }
  }

  /**
   * è·å–æ–‡ä»¶å†…å®¹
   */
  async getFile(path: string): Promise<string> {
    try {
      const response = await this.plugin.kernelApi('/api/file/getFile', {
        path
      });
      
      if (response.code !== 0) {
        throw new Error(`Failed to get file: ${response.msg}`);
      }
      
      return response.data;
    } catch (error: unknown) {
      if (error instanceof Error) {
        console.error(`Failed to get file ${path}:`, error.message);
        throw error;
      }
      throw new Error('Unknown error in getFile');
    }
  }

  /**
   * ä¿å­˜æ–‡ä»¶å†…å®¹
   */
  async putFile(path: string, content: string): Promise<void> {
    try {
      const response = await this.plugin.kernelApi('/api/file/putFile', {
        path,
        file: content
      });
      
      if (response.code !== 0) {
        throw new Error(`Failed to save file: ${response.msg}`);
      }
    } catch (error: unknown) {
      if (error instanceof Error) {
        console.error(`Failed to save file ${path}:`, error.message);
        throw error;
      }
      throw new Error('Unknown error in putFile');
    }
  }

  /**
   * æ’å…¥å—
   */
  async insertBlock(
    dataType: 'markdown' | 'dom',
    data: string,
    parentID?: string
  ): Promise<Block[]> {
    try {
      const response = await this.plugin.kernelApi('/api/block/insertBlock', {
        dataType,
        data,
        parentID
      });
      
      if (response.code !== 0) {
        throw new Error(`Failed to insert block: ${response.msg}`);
      }
      
      return response.data || [];
    } catch (error: unknown) {
      if (error instanceof Error) {
        console.error('Failed to insert block:', error.message);
        throw error;
      }
      throw new Error('Unknown error in insertBlock');
    }
  }

  /**
   * è·å–å—ä¿¡æ¯
   */
  async getBlockInfo(id: string): Promise<Block | null> {
    try {
      const blocks = await this.queryBlocks(
        `SELECT * FROM blocks WHERE id = '${id}'`
      );
      return blocks.length > 0 ? blocks[0] : null;
    } catch (error: unknown) {
      if (error instanceof Error) {
        console.error(`Failed to get block info for ${id}:`, error.message);
        throw error;
      }
      throw new Error('Unknown error in getBlockInfo');
    }
  }

  /**
   * è·å–æ–‡æ¡£æ ‘
   */
  async getDocTree(): Promise<FileTreeNode[]> {
    try {
      const response = await this.plugin.kernelApi('/api/filetree/getDoc', {});
      
      if (response.code !== 0) {
        throw new Error(`Failed to get doc tree: ${response.msg}`);
      }
      
      return response.data || [];
    } catch (error: unknown) {
      if (error instanceof Error) {
        console.error('Failed to get doc tree:', error.message);
        throw error;
      }
      throw new Error('Unknown error in getDocTree');
    }
  }
}

// ç±»å‹å®šä¹‰
interface Block {
  id: string;
  parent_id: string;
  root_id: string;
  hash: string;
  box: string;
  path: string;
  hpath: string;
  name: string;
  alias: string;
  memo: string;
  tag: string;
  content: string;
  markdown: string;
  length: number;
  type: string;
  subtype: string;
  ial: string;
  sort: number;
  created: string;
  updated: string;
}

interface FileTreeNode {
  id: string;
  name: string;
  type: string;
  path: string;
  children?: FileTreeNode[];
}
```

### æ’ä»¶ç”Ÿå‘½å‘¨æœŸç®¡ç†

```typescript
// src/index.ts
import {Plugin} from 'siyuan';
import type {PluginSettings} from '@/types/plugin-types';
import {SiYuanApiClient} from '@/utils/siYuanApi';
import {createI18nHelper} from '@/utils/i18n';
import SettingsPanel from '@/components/SettingsPanel.svelte';

export default class MyAwesomePlugin extends Plugin {
  private readonly apiClient: SiYuanApiClient;
  private readonly i18nHelper: ReturnType<typeof createI18nHelper>;
  private settingsPanel: SettingsPanel | null = null;
  private eventHandlers: Map<string, Function> = new Map();

  // é»˜è®¤è®¾ç½®
  private static readonly DEFAULT_SETTINGS: PluginSettings = {
    apiKey: '',
    enableDebug: false,
    maxRetries: 3,
    theme: 'auto'
  };

  constructor() {
    super();
    this.apiClient = new SiYuanApiClient(this);
    this.i18nHelper = createI18nHelper(this);
  }

  async onload(): Promise<void> {
    console.log('Loading MyAwesome Plugin...');

    try {
      await this.initializePlugin();
      await this.registerEventHandlers();
      this.addTopBarIcon();
      
      console.log('MyAwesome Plugin loaded successfully');
    } catch (error: unknown) {
      if (error instanceof Error) {
        console.error('Failed to load plugin:', error.message);
        this.showMessage(`Plugin load failed: ${error.message}`, 5000, 'error');
      }
    }
  }

  onunload(): void {
    console.log('Unloading MyAwesome Plugin...');
    
    // æ¸…ç†èµ„æº
    this.cleanupEventHandlers();
    this.destroySettingsPanel();
    
    console.log('MyAwesome Plugin unloaded');
  }

  async onLayoutReady(): Promise<void> {
    console.log('Layout ready, performing additional initialization...');
    
    try {
      await this.loadUserData();
    } catch (error: unknown) {
      if (error instanceof Error) {
        console.error('Failed to load user data:', error.message);
      }
    }
  }

  private async initializePlugin(): Promise<void> {
    // åŠ è½½è®¾ç½®
    const savedSettings = await this.loadData();
    const settings: PluginSettings = {
      ...MyAwesomePlugin.DEFAULT_SETTINGS,
      ...savedSettings
    };
    
    // éªŒè¯è®¾ç½®
    this.validateSettings(settings);
    
    // ä¿å­˜åˆå¹¶åçš„è®¾ç½®
    await this.saveData(settings);
  }

  private validateSettings(settings: PluginSettings): void {
    if (settings.maxRetries < 1 || settings.maxRetries > 10) {
      throw new Error('Max retries must be between 1 and 10');
    }
    
    if (settings.apiKey && !/^sk-[a-zA-Z0-9]{32,}$/.test(settings.apiKey)) {
      console.warn('API key format appears invalid');
    }
  }

  private async registerEventHandlers(): Promise<void> {
    // æ³¨å†Œäº‹ä»¶å¤„ç†å™¨
    const documentHandler = this.handleDocumentChange.bind(this);
    const blockHandler = this.handleBlockUpdate.bind(this);
    
    this.eventBus.on('switch-protyle', documentHandler);
    this.eventBus.on('input-block', blockHandler);
    
    // ä¿å­˜å¼•ç”¨ä»¥ä¾¿æ¸…ç†
    this.eventHandlers.set('switch-protyle', documentHandler);
    this.eventHandlers.set('input-block', blockHandler);
  }

  private cleanupEventHandlers(): void {
    this.eventHandlers.forEach((handler, event) => {
      this.eventBus.off(event, handler);
    });
    this.eventHandlers.clear();
  }

  private addTopBarIcon(): void {
    this.addTopBar({
      icon: 'iconPlugin',
      title: this.i18nHelper.t('plugin.name'),
      position: 'right',
      callback: () => this.showSettingsPanel()
    });
  }

  private showSettingsPanel(): void {
    if (this.settingsPanel) {
      this.destroySettingsPanel();
    }

    this.settingsPanel = new SettingsPanel({
      target: document.body,
      props: {
        plugin: this,
        isVisible: true
      }
    });

    // ç›‘å¬äº‹ä»¶
    this.settingsPanel.$on('save', this.handleSettingsSave.bind(this));
    this.settingsPanel.$on('cancel', this.destroySettingsPanel.bind(this));
  }

  private destroySettingsPanel(): void {
    if (this.settingsPanel) {
      this.settingsPanel.$destroy();
      this.settingsPanel = null;
    }
  }

  private async handleSettingsSave(event: CustomEvent<PluginSettings>): Promise<void> {
    try {
      const newSettings = event.detail;
      this.validateSettings(newSettings);
      
      await this.saveData(newSettings);
      this.showMessage(this.i18nHelper.t('ui.messages.saveSuccess'), 3000);
      this.destroySettingsPanel();
    } catch (error: unknown) {
      if (error instanceof Error) {
        this.showMessage(
          this.i18nHelper.t('ui.messages.saveError', error.message),
          5000,
          'error'
        );
      }
    }
  }

  private handleDocumentChange(event: any): void {
    console.log('Document changed:', event);
    // å¤„ç†æ–‡æ¡£åˆ‡æ¢é€»è¾‘
  }

  private handleBlockUpdate(event: any): void {
    console.log('Block updated:', event);
    // å¤„ç†å—æ›´æ–°é€»è¾‘
  }

  private async loadUserData(): Promise<void> {
    try {
      const userData = await this.apiClient.queryBlocks(
        "SELECT * FROM blocks WHERE type = 'd' LIMIT 10"
      );
      console.log('Loaded user data:', userData.length);
    } catch (error: unknown) {
      if (error instanceof Error) {
        console.warn('Failed to load user data:', error.message);
      }
    }
  }

  // å…¬å…± API æ–¹æ³•
  public async getSettings(): Promise<PluginSettings> {
    return await this.loadData() || MyAwesomePlugin.DEFAULT_SETTINGS;
  }

  public async updateSettings(newSettings: Partial<PluginSettings>): Promise<void> {
    const currentSettings = await this.getSettings();
    const mergedSettings = {...currentSettings, ...newSettings};
    
    this.validateSettings(mergedSettings);
    await this.saveData(mergedSettings);
  }
}
```

## ğŸ§ª æµ‹è¯•å’Œè°ƒè¯•é…ç½®

### Jest æµ‹è¯•é…ç½®

```javascript
// jest.config.js
module.exports = {
  preset: 'ts-jest',
  testEnvironment: 'jsdom',
  setupFilesAfterEnv: ['<rootDir>/src/__tests__/setup.ts'],
  moduleNameMapping: {
    '^@/(.*)$': '<rootDir>/src/$1',
    '^@components/(.*)$': '<rootDir>/src/components/$1',
    '^@utils/(.*)$': '<rootDir>/src/utils/$1',
    '^@types/(.*)$': '<rootDir>/src/types/$1'
  },
  transform: {
    '^.+\\.svelte$': [
      'svelte-jester',
      {
        preprocess: true
      }
    ],
    '^.+\\.ts$': 'ts-jest'
  },
  moduleFileExtensions: ['js', 'ts', 'svelte'],
  testMatch: [
    '<rootDir>/src/**/__tests__/**/*.{js,ts}',
    '<rootDir>/src/**/*.{test,spec}.{js,ts}'
  ],
  collectCoverageFrom: [
    'src/**/*.{ts,svelte}',
    '!src/**/*.d.ts',
    '!src/__tests__/**/*'
  ],
  coverageThreshold: {
    global: {
      branches: 80,
      functions: 80,
      lines: 80,
      statements: 80
    }
  }
};
```

### æµ‹è¯•ç¤ºä¾‹

```typescript
// src/__tests__/utils/apiClient.test.ts
import {SiYuanApiClient} from '@/utils/siYuanApi';
import type {Plugin} from 'siyuan';

describe('SiYuanApiClient', () => {
  let mockPlugin: jest.Mocked<Plugin>;
  let apiClient: SiYuanApiClient;

  beforeEach(() => {
    mockPlugin = {
      kernelApi: jest.fn(),
      showMessage: jest.fn()
    } as any;

    apiClient = new SiYuanApiClient(mockPlugin);
  });

  describe('queryBlocks', () => {
    it('should return blocks on successful query', async () => {
      const mockBlocks = [
        {id: '1', content: 'Test block 1'},
        {id: '2', content: 'Test block 2'}
      ];

      mockPlugin.kernelApi.mockResolvedValue({
        code: 0,
        data: mockBlocks
      });

      const result = await apiClient.queryBlocks('SELECT * FROM blocks');

      expect(result).toEqual(mockBlocks);
      expect(mockPlugin.kernelApi).toHaveBeenCalledWith('/api/query/sql', {
        stmt: 'SELECT * FROM blocks'
      });
    });

    it('should throw error on API failure', async () => {
      mockPlugin.kernelApi.mockResolvedValue({
        code: 1,
        msg: 'Database error'
      });

      await expect(
        apiClient.queryBlocks('INVALID SQL')
      ).rejects.toThrow('API Error: Database error');
    });

    it('should handle network errors', async () => {
      mockPlugin.kernelApi.mockRejectedValue(new Error('Network error'));

      await expect(
        apiClient.queryBlocks('SELECT * FROM blocks')
      ).rejects.toThrow('Network error');
    });
  });
});
```

### è°ƒè¯•é…ç½®

```json
// .vscode/launch.json
{
  "version": "0.2.0",
  "configurations": [
    {
      "name": "Debug Plugin in SiYuan",
      "type": "node",
      "request": "attach",
      "port": 9229,
      "address": "localhost",
      "localRoot": "${workspaceFolder}/src",
      "remoteRoot": "/plugin-root/src",
      "skipFiles": ["<node_internals>/**"]
    },
    {
      "name": "Run Tests",
      "type": "node",
      "request": "launch",
      "program": "${workspaceFolder}/node_modules/.bin/jest",
      "args": ["--runInBand", "--no-cache"],
      "console": "integratedTerminal",
      "internalConsoleOptions": "neverOpen"
    }
  ]
}
```

### å¼€å‘ç¯å¢ƒé…ç½®

```json
// .vscode/settings.json
{
  "typescript.preferences.quoteStyle": "single",
  "typescript.format.semicolons": "insert",
  "typescript.suggest.autoImports": true,
  "typescript.updateImportsOnFileMove.enabled": "always",
  
  "eslint.validate": ["typescript", "svelte"],
  "eslint.workingDirectories": ["src"],
  
  "editor.formatOnSave": true,
  "editor.codeActionsOnSave": {
    "source.fixAll.eslint": "explicit",
    "source.organizeImports": "explicit"
  },
  
  "[svelte]": {
    "editor.defaultFormatter": "svelte.svelte-vscode"
  },
  "[typescript]": {
    "editor.defaultFormatter": "esbenp.prettier-vscode"
  },
  "[json]": {
    "editor.defaultFormatter": "esbenp.prettier-vscode"
  },
  
  "svelte.enable-ts-plugin": true,
  "svelte.plugin.css.diagnostics.enable": true,
  "svelte.plugin.css.completions.enable": true,
  
  "files.associations": {
    "*.svelte": "svelte"
  },
  
  "emmet.includeLanguages": {
    "svelte": "html"
  }
}
```

## ğŸš€ æ„å»ºå’Œéƒ¨ç½²è‡ªåŠ¨åŒ–

### GitHub Actions å·¥ä½œæµ

```yaml
# .github/workflows/ci.yml
name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  release:
    types: [created]

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run linter
        run: npm run lint
        
      - name: Run type checking
        run: npm run check
        
      - name: Run tests
        run: npm test -- --coverage
        
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info
          
  build:
    needs: lint-and-test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Build plugin
        run: npm run build
        
      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: plugin-build
          path: dist/
          
  release:
    if: github.event_name == 'release'
    needs: [lint-and-test, build]
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Build plugin
        run: npm run build
        
      - name: Create release package
        run: |
          cd dist
          zip -r ../plugin-release.zip .
          
      - name: Upload release asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./plugin-release.zip
          asset_name: plugin-release.zip
          asset_content_type: application/zip
```

### å¼€å‘è„šæœ¬

```javascript
// scripts/make-package.js
const fs = require('fs');
const path = require('path');
const archiver = require('archiver');

async function createPackage() {
  const packageJson = JSON.parse(
    fs.readFileSync('package.json', 'utf8')
  );
  
  const pluginJson = JSON.parse(
    fs.readFileSync('plugin.json', 'utf8')
  );
  
  // ç¡®ä¿ç‰ˆæœ¬åŒæ­¥
  if (packageJson.version !== pluginJson.version) {
    console.warn('Version mismatch between package.json and plugin.json');
  }
  
  const distPath = path.resolve('dist');
  const packagePath = path.resolve(`${pluginJson.name}-${pluginJson.version}.zip`);
  
  if (!fs.existsSync(distPath)) {
    console.error('dist directory not found. Run build first.');
    process.exit(1);
  }
  
  const output = fs.createWriteStream(packagePath);
  const archive = archiver('zip', {zlib: {level: 9}});
  
  return new Promise((resolve, reject) => {
    output.on('close', () => {
      console.log(`Package created: ${packagePath} (${archive.pointer()} bytes)`);
      resolve();
    });
    
    archive.on('error', reject);
    archive.pipe(output);
    archive.directory(distPath, false);
    archive.finalize();
  });
}

createPackage().catch(console.error);
```

```javascript
// scripts/make-dev-link.js
const fs = require('fs');
const path = require('path');
const os = require('os');

function createSymlink() {
  const pluginJson = JSON.parse(
    fs.readFileSync('plugin.json', 'utf8')
  );
  
  const devPath = path.resolve('dev');
  const siyuanPath = getSiyuanPluginsPath();
  
  if (!siyuanPath) {
    console.error('SiYuan plugins directory not found');
    process.exit(1);
  }
  
  const targetPath = path.join(siyuanPath, pluginJson.name);
  
  try {
    if (fs.existsSync(targetPath)) {
      fs.rmSync(targetPath, {recursive: true, force: true});
    }
    
    fs.symlinkSync(devPath, targetPath, 'junction');
    console.log(`Symlink created: ${devPath} -> ${targetPath}`);
  } catch (error) {
    console.error('Failed to create symlink:', error.message);
    if (os.platform() === 'win32') {
      console.log('On Windows, try running as administrator');
    }
    process.exit(1);
  }
}

function getSiyuanPluginsPath() {
  const platform = os.platform();
  const homeDir = os.homedir();
  
  const paths = {
    win32: path.join(homeDir, 'AppData', 'Roaming', 'SiYuan', 'data', 'plugins'),
    darwin: path.join(homeDir, 'Library', 'Application Support', 'SiYuan', 'data', 'plugins'),
    linux: path.join(homeDir, '.config', 'SiYuan', 'data', 'plugins')
  };
  
  const siyuanPath = paths[platform];
  return fs.existsSync(siyuanPath) ? siyuanPath : null;
}

createSymlink();
```

## ğŸ“‹ ä»£ç æ£€æŸ¥æ¸…å•

åœ¨æäº¤ä»£ç å‰ï¼Œè¯·ç¡®ä¿é€šè¿‡ä»¥ä¸‹æ£€æŸ¥ï¼š

### âœ… TypeScript è§„èŒƒæ£€æŸ¥

- [ ] æ‰€æœ‰å˜é‡ä½¿ç”¨ `const` æˆ– `let`ï¼Œé¿å… `var`
- [ ] å‡½æ•°æœ‰æ˜ç¡®çš„è¿”å›ç±»å‹æ³¨è§£
- [ ] é¿å…ä½¿ç”¨ `any` ç±»å‹ï¼Œä½¿ç”¨ `unknown` ä»£æ›¿
- [ ] ä½¿ç”¨å‘½åå¯¼å‡ºè€Œä¸æ˜¯é»˜è®¤å¯¼å‡º
- [ ] ç±»å‹æ–­è¨€ä½¿ç”¨ `as` è¯­æ³•è€Œä¸æ˜¯å°–æ‹¬å·
- [ ] é”™è¯¯å¤„ç†ä½¿ç”¨ `Error` å®ä¾‹è€Œä¸æ˜¯å­—ç¬¦ä¸²
- [ ] ä½¿ç”¨ç»“æ„åŒ–ç±»å‹å’Œæ¥å£

### âœ… Svelte ç»„ä»¶æ£€æŸ¥

- [ ] ç»„ä»¶ script éƒ¨åˆ†æŒ‰ç…§æ¨èé¡ºåºç»„ç»‡
- [ ] Props æœ‰æ˜ç¡®çš„ç±»å‹å®šä¹‰
- [ ] äº‹ä»¶åˆ†å‘å™¨æœ‰ç±»å‹çº¦æŸ
- [ ] æ ·å¼ä½¿ç”¨ CSS å˜é‡é€‚é…ä¸»é¢˜
- [ ] ç»„ä»¶å…·æœ‰è‰¯å¥½çš„å¯è®¿é—®æ€§

### âœ… æ€æºç¬”è®°ç‰¹å®šæ£€æŸ¥

- [ ] ä½¿ç”¨å†…æ ¸ API è€Œä¸æ˜¯ç›´æ¥æ–‡ä»¶æ“ä½œ
- [ ] æ”¯æŒå¤šè¯­è¨€å›½é™…åŒ–
- [ ] æ­£ç¡®å¤„ç†æ’ä»¶ç”Ÿå‘½å‘¨æœŸ
- [ ] æ¸…ç†äº‹ä»¶ç›‘å¬å™¨å’Œèµ„æº
- [ ] é”™è¯¯å¤„ç†å’Œç”¨æˆ·åé¦ˆ

### âœ… ä»£ç è´¨é‡æ£€æŸ¥

- [ ] é€šè¿‡ ESLint æ£€æŸ¥ (`npm run lint`)
- [ ] é€šè¿‡ TypeScript æ£€æŸ¥ (`npm run check`)
- [ ] é€šè¿‡ Prettier æ ¼å¼åŒ– (`npm run format`)
- [ ] æµ‹è¯•è¦†ç›–ç‡è¾¾åˆ°è¦æ±‚
- [ ] æ–‡æ¡£å’Œæ³¨é‡Šå®Œæ•´

## ğŸ‰ æ€»ç»“

è¿™ä»½æŒ‡å—æä¾›äº†ä¸€å¥—å®Œæ•´çš„ Google æ ‡å‡†ç¼–ç è§„èŒƒï¼Œä¸“é—¨é’ˆå¯¹æ€æºç¬”è®°æ’ä»¶å¼€å‘è¿›è¡Œäº†ä¼˜åŒ–ã€‚éµå¾ªè¿™äº›è§„èŒƒå°†å¸®åŠ©ä½ ï¼š

1. **ç¼–å†™é«˜è´¨é‡ä»£ç ** - éµå¾ªä¸šç•Œæœ€ä½³å®è·µ
2. **æé«˜å¯ç»´æŠ¤æ€§** - ç»Ÿä¸€çš„ä»£ç é£æ ¼å’Œç»“æ„
3. **å‡å°‘é”™è¯¯** - ä¸¥æ ¼çš„ç±»å‹æ£€æŸ¥å’Œé”™è¯¯å¤„ç†
4. **æå‡å¼€å‘æ•ˆç‡** - è‡ªåŠ¨åŒ–å·¥å…·é“¾å’Œå¼€å‘æµç¨‹
5. **æ”¯æŒå›½é™…åŒ–** - å¤šè¯­è¨€æ”¯æŒå’Œæœ¬åœ°åŒ–

è®°ä½ï¼Œå¥½çš„ä»£ç ä¸ä»…è¦èƒ½å·¥ä½œï¼Œè¿˜è¦æ˜“è¯»ã€æ˜“ç»´æŠ¤ã€æ˜“æ‰©å±•ã€‚è¿™ä»½æŒ‡å—å°±æ˜¯ä¸ºäº†å¸®åŠ©ä½ è¾¾åˆ°è¿™ä¸ªç›®æ ‡ï¼

å¼€å§‹ç¼–å†™ä½ çš„ä¸‹ä¸€ä¸ªæ€æºç¬”è®°æ’ä»¶å§ï¼ğŸš€