好的，完全明白。这是一个至关重要的步骤。我们需要一份详尽、清晰、能作为“开发圣经”的最终蓝图，以便让AI（或者任何参与开发的工程师）能够准确理解我们从始至终的每一个决策和最终目标。

这份文档将不再是讨论稿，而是一份正式的、结构化的**项目需求与设计说明书**。它会详细阐述我们项目的哲学、核心模块、功能规格和技术实现要点。我会假设这份文档的读者不了解我们之前的任何讨论。

---

### **项目名称：思源笔记的 Obsidian 可视化工作台**

**版本：** 1.0
**目标：** 打造一个以卡片为核心、深度集成于 Obsidian 的可视化知识管理工作台，旨在高效实践卢曼卡片盒（Zettelkasten）笔记法，并将思源笔记作为可选的外部知识源。

#### **一、 核心设计哲学**

本项目旨在解决知识在不同笔记中被孤立的问题。传统的笔记方式让想法难以连接和发展，而我们的目标是提供一个可视化的“工作室”，让用户可以：
1.  **将所有知识原子化**：每一条笔记、每一个想法，都被视为一张独立的“卡片”。
2.  **可视化连接与组织**：在无限画布上，自由地布局、连接、组合这些卡片，形成网状的“想法簇”。
3.  **促进想法的演化**：通过直观的操作，将零散的“闪念笔记”和“文献笔记”发展为结构化的“永久笔记”。

我们不重复造轮子，而是选择**以 Obsidian 成熟的生态为基座，以其 Canvas（白板）功能为核心进行深度增强**，同时为未来连接思源笔记等外部知识库预留接口。

---

#### **二、 系统核心模块分解**

本插件由三大核心模块构成，它们共同组成一个完整的工作流：

**模块一：全局卡片库 (The Universal Card Library) - 知识调度中心**

这是用户与知识卡片交互的主要入口，以 Obsidian 侧边栏视图的形式常驻。它彻底改变了传统的文件列表浏览模式。

* **功能规格：**
    1.  **双轨制卡片来源**:
        * **文件卡 (File Cards)**: 自动索引并实时展示 Obsidian 库中的所有 `.md` 笔记文件。每一篇笔记即为一张“文件卡”。
        * **原生卡 (Native Cards)**: 能够解析指定 `.canvas` 文件，并展示其中所有**不对应任何独立文件的、仅存在于白板内的文本卡片**。
    2.  **上下文感知筛选系统**:
        * **项目/白板筛选器 (核心功能)**:
            * 提供一个下拉菜单或搜索框，列出库中所有的 `.canvas` 文件。
            * **全局模式（默认）**: 显示整个库中所有的“文件卡”，用于全局知识发现和调度。
            * **白板模式**: 当选择某个白板文件（如 `项目A.canvas`）后，卡片库列表会**动态更新**，仅显示该白板已引用的“文件卡”和其内部包含的所有“原生卡”，让用户能完全沉浸在当前项目的上下文中。
        * **标签筛选器**: 允许用户通过点击 `#标签`，快速过滤当前视图下的卡片。
        * **全文检索**: 提供实时搜索功能，能快速在当前视图的卡片中，根据标题或内容进行检索。
* **技术要点**:
    * 使用 Obsidian API `app.workspace.onLayoutReady` 创建一个侧边栏视图 (`ItemView`)。
    * 使用 `app.vault.getMarkdownFiles()` 来获取所有文件卡。
    * 通过 `app.vault.read(file)` 和 `JSON.parse()` 来解析 `.canvas` 文件，提取原生卡片数据。
    * UI 交互需要高效的虚拟列表（Virtual List）技术来承载可能成千上万的卡片，避免性能问题。

**模块二：增强型白板 (The Enhanced Canvas) - 思考与创作工作室**

这是项目的核心操作区。我们将在 Obsidian 原生的 Canvas 功能之上，注入强大的思维导图式交互和符合卢曼笔记法的工作流。

* **功能规格：**
    1.  **拖拽即用**:
        * 从“全局卡片库”中拖拽任意卡片（文件卡或原生卡）到白板上，即可创建对应的节点。
        * 从外部（如浏览器）拖拽链接或文本，也能在白板上创建对应的卡片。
    2.  **思维导图式快捷操作**:
        * **创建子/同级节点**: 选中一个节点后，按 `Tab` 键创建子节点（右侧），按 `Enter` 键创建同级节点（下方），并自动用默认连线连接。
        * **右键菜单**: 提供与快捷键功能相同的菜单选项。
    3.  **强大的节点功能**:
        * **类型区分**: 白板上的节点明确区分为“文件节点”和“原生节点”。
        * **直接编辑**: 双击原生节点可直接编辑其文本内容。双击文件节点则会打开其对应的 `.md` 文件。
        * **颜色分类**: 右键节点可快速应用预设的颜色分类（如“闪念笔记”、“文献笔记”等），颜色与卡片库中的标签系统联动。
        * **卡片升级**: 右键点击一个“原生卡片”，可选择“提升为笔记”，插件会自动在库中创建一个新的 `.md` 文件，将卡片内容存入，并更新白板上的节点为文件节点。
    4.  **分组/想法簇**:
        * 选中多个节点后，使用快捷键 (`Ctrl/Cmd + G`) 可以将它们包裹进一个“分组”节点中。
        * 分组节点在视觉上是一个可调整大小的容器，可以整体拖动、折叠/展开，并可作为连接的对象。

* **技术要点**:
    * 熟练运用 HTML5 Drag and Drop API，处理跨组件（侧边栏到Canvas）的拖拽事件和数据传递。
    * 通过监听 Canvas 区域的 `drop` 事件，调用 React Flow（或其底层API）的 `addNodes` 方法创建新节点。
    * 通过监听 `keydown` 事件并判断焦点元素，实现 `Tab`/`Enter` 等快捷键操作。
    * “卡片升级”功能需要调用 Obsidian API `app.vault.create()` 来创建新文件。

**模块三：网格视图与辅助工具 (The Grid Dashboard & Utilities)**

这是对 `Canvasgrid-Transit` 插件的继承与深度整合，作为白板的辅助管理视图和效率工具。

* **功能规格：**
    1.  **切换式网格视图**:
        * 在 Canvas 工具栏中提供一个切换按钮，点击后可以将当前白板的视图模式从“自由布局”切换为“网格布局”。
        * 网格视图以紧凑的卡片形式展示当前白板上的**所有节点**（包括文件卡和原生卡），并提供**排序**（按创建时间、修改时间、标题）功能。
    2.  **时间胶囊 (Time Capsule) 模式**:
        * 这是一个特殊的“灵感捕捉”功能。在网格视图的工具栏上提供入口。
        * 启动后，在设定的时间内（如15分钟），用户可以通过快捷键快速将各处的想法（如选中的文本）收集起来。
        * 时间结束后，所有被收集的想法会自动在当前白板上生成一个名为“XX时间的时间胶囊”的**分组**，内部包含了所有收集到的**原生卡片**。
    3.  **无感自动保存**:
        * 无论是白板视图还是网格视图，用户的所有操作（移动节点、编辑文本、创建连接等）都会被实时监听。
        * 通过 **防抖 (debounce)** 机制，在用户停止操作 2 秒后，自动将所有变更写入对应的 `.canvas` 文件，全程无需用户手动点击“保存”。
    4.  **核心辅助工具**:
        * **小地图 (Minimap)**: 在白板右下角提供一个画布的鸟瞰图，方便快速导航。
        * **撤销/重做 (Undo/Redo)**: 在工具栏提供“撤销”和“重做”按钮，所有对画布的操作都能被记录和回滚。

* **技术要点**:
    * 深度理解 `Canvasgrid-Transit` 的代码，将其从一个独立插件，重构为一个由我们主插件调用的“视图模块”。
    * 引入 `Zustand` 和其 `temporal` 中间件，构建一个统一的状态管理 store，将 Canvas 的 `nodes` 和 `edges` 数据纳入其中，以实现可靠的撤销/重做功能。
    * 利用 `zustand` 的 `subscribe` 方法，结合 `lodash-es` 的 `debounce` 函数，实现高性能的自动保存逻辑。

---

#### **四、 关于思源笔记的未来集成规划**

本项目当前阶段**不直接处理**与思源笔记的技术对接，以保证核心功能的稳定和快速交付。用户可以通过手动复制思源笔记的网页链接并粘贴到 Obsidian Canvas 的方式进行使用。

在未来，我们将开发一个**独立的、轻量级的“思源助手（Siyuan Connector）”插件**，其唯一职责是：
1.  在思源笔记的 Web 版界面，为每个笔记块添加一个“发送到 Obsidian”的按钮。
2.  点击后，该助手插件将生成此笔记块的唯一分享链接。
3.  通过自定义 URI 协议 (`obsidian://...`)，将此链接发送给我们的 Obsidian 主插件。
4.  我们的主插件监听到此 URI 后，在“全局卡片库”中自动创建一个新的“外部卡片”，用户即可将其拖入任意白板使用。

---

这份文档详细定义了我们项目的**是什么 (What)**、**为什么 (Why)** 和 **怎么做 (How)**。它将是我们未来开发过程中的北极星，确保我们每一步行动都统一在同一个宏大而清晰的目标之下。